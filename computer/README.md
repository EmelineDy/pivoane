All of the codes in the `computer/ros2_ws/darknet_ros_yolov4` were based in the following github: https://github.com/Ar-Ray-code/darknet_ros_fp16.git. We did some modification only in some ROS nodes and topics to adapt the object detection behavior for our project. With our modifications we will send only the closest panel and the closes pedestrian based in the estimated distance of them.

# How to configure to train and analyze performance of Yolo (darknet)

All this part related to train and analyze performance of darknet are available in `pivoane/computer/ros2_ws/src/darknet_ros_yolov4/darknet_ros/darknet` because it is not related with ROS.


There is many kind of files which are important for the AI model.
* **file.data**: inform the number of class and the path for train, validation, name of classes and backup file to store weights file file.weights
* **file.names**: inform the label names for all classes
* **file.names**: inform the label names for all classes
* **test.txt**: inform the path for all images for testing
* **train.txt**: inform the path for all images for training
* **file.cfg**: inform the neural network architecture, number of layers, configurations of convolutional layers, number of neuros ...
* **file.weights**: file with all network weights generated by a training
* **file.conv.X**: file with initial weights for train a new model
* **file.yaml**: inform all relevant information to use the AI in darknet_ros such as file.cfg, file.weights, detection threshold and label names

## Train new model
The training will generate a new model (file.weights) in the /backup file
```
./darknet detector train myModel/data/myClasses.data myModel/yolov7-tiny/yolov7-tiny-myClasses.cfg myModel/yolov7-tiny/yolov7-tiny.conv.87 -map
```

## Continue old training
Use a previous trained model (file.weights) to do fine-tuning
```
./darknet detector train myModel/data/myClasses.data myModel/yolov7-tiny/yolov7-tiny-myClasses.cfg myModel/backup/<name_of_weight_file.weights> -map
```

## Calculation of mAP, F1, IoU, Precision-Recall of test data
Calculate more metrics to evaluate the performance of the model
```
./darknet detector recall myModel/data/myClasses.data myModel/yolov7-tiny/yolov7-tiny-myClasses.cfg myModel/backup/<name_of_weight_file.weights> -thresh 0.5
```
```
./darknet detector map myModel/data/myClasses.data myModel/yolov7-tiny/yolov7-tiny-myClasses.cfg myModel/backup/<name_of_weight_file.weights> -thresh 0.5
```

## Pass images to do prediction
```
./darknet detector test myModel/data/myClasses.data myModel/yolov7-tiny/yolov7-tiny-myClasses.cfg myModel/backup/yolov4-tiny-myClasses_final.weights -thresh 0.5
```
## Do validation with test dataset
```
./darknet detector valid myModel/data/myClasses.data myModel/yolov7-tiny/yolov7-tiny-myClasses.cfg myModel/backup/<name_of_weight_file.weights> -thresh 0.5
```

# How to use a trained darknet model in ROS
All this part related  are available in `pivoane/computer/ros2_ws/src/darknet_ros_yolov4/darknet_ros/darknet_ros` because it is a ros package. All ROS messages are available in `pivoane/computer/ros2_ws/src/darknet_ros_yolov4/darknet_ros/darknet_ros_msgs`

* **darknet_ros/yolo_network_config/cfg**: store all file.cfg used on ROS
* **darknet_ros/yolo_network_config/weights**: store all file.weights used on ROS
* **darknet_ros/config**: store all file.yaml used on ROS
* **darknet_ros/launch/file.launch.py**: launch file containing the path of file.yaml and some informations for the camera node such as the device identification and camera resolution
* **darknet_ros/src/YoloObjectDetector.cpp**: Node responsible for the object detection, it is possible to change this node to change the detection behavior (what we did).

## Open existing docker container
Due to the presence of many packages and management of versions we are using a docker container to run ROS. However we cannot open a graphic interface directly in a container, hence we should do a connection to the container from ssh connection.

Start docker container and enable ssh connection
```
docker start -ai ros-car
/etc/init.d/ssh restart
```
Open a new terminal and connect to container using ssh connection (in this new terminal it is possible to open graphic interface to see the camera image)

```
ssh -Y root@<docker_ip> -p <number_of_configured_port>
```

## Run launch file inside docker container
Due to the presence of two cameras we developed two launch file, one for each camera. Execute one of this launch inside the docker container connected by ssh to see the camera image.
```
ros2 launch darknet_ros yolov7-tiny-myClasses-video0.launch.py
```
or
```
ros2 launch darknet_ros yolov7-tiny-myClasses-video2.launch.py
```
